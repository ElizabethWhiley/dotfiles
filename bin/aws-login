#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

die() { echo "ERROR: $*" >&2; exit "${2:-1}"; }

have() { command -v "$1" >/dev/null 2>&1; }

have aws || die "aws CLI not found in PATH" 2

# No args → print login commands
if [ $# -eq 0 ]; then
  found=0
  for p in $(aws configure list-profiles 2>/dev/null); do
    if aws configure get sso_session --profile "$p" >/dev/null 2>&1; then
      echo "aws sso login --profile $p"
      found=1
    fi
  done

  if [ $found -eq 0 ]; then
    die "No SSO profiles found. Run: aws configure sso" 1
  fi
  exit 0
fi

# One arg → do the login
profile="$1"

if ! aws configure get sso_session --profile "$profile" >/dev/null 2>&1; then
  die "Profile '$profile' is not configured for SSO." 3
fi

echo "Running: aws sso login --profile $profile"
aws sso login --profile "$profile"

echo "Validating session..."
aws sts get-caller-identity --profile "$profile" --no-cli-pager >/dev/null
